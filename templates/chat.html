<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethco AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-color: #1a1a1a;
            --sidebar-color: #101010;
            --surface-color: #2c2c2c;
            --primary-accent: #e53935; /* Tomato Red */
            --primary-accent-hover: #f44336;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --user-bubble-bg: #373737;
            --ai-bubble-bg: #2c2c2c;
            --tool-call-bg: #282a36;
            --tool-output-bg: #1e1e1e;
            --success-color: #4caf50;
            --failure-color: #f44336;
        }

        body, html { height: 100vh; margin: 0; background-color: var(--bg-color); color: var(--text-primary); font-family: 'Google Sans', sans-serif; overflow: hidden; }
        #main-layout { display: flex; height: 100vh; position: relative; }

        #sidebar { width: 280px; background-color: var(--sidebar-color); flex-shrink: 0; display: flex; flex-direction: column; padding: 1rem; border-right: 1px solid var(--surface-color); transition: transform 0.3s ease; }
        #new-chat-btn { background-color: var(--primary-accent); border: none; }
        #new-chat-btn:hover { background-color: var(--primary-accent-hover); }

        #history-list { flex-grow: 1; overflow-y: auto; margin-top: 1.5rem; list-style: none; padding: 0; }
        .history-item { padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); }
        .history-item:hover { background-color: var(--surface-color); }
        .history-item.active { background-color: var(--primary-accent); color: var(--text-primary); }

        #chat-view { flex-grow: 1; display: flex; flex-direction: column; max-width: 800px; width: 100%; margin: 0 auto; }
        .chat-header { padding: 1rem 1rem; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; }
        #sidebar-toggle { display: none; font-size: 1.5rem; background: none; border: none; color: var(--text-primary); }
        .chat-header h5 { font-weight: 500; font-size: 1.25rem; }
        .chat-header .profile-icon { font-size: 1.8rem; color: var(--text-primary); text-decoration: none; }
        
        #chat-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; padding: 1rem; }
        #welcome-screen { flex-grow: 1; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.5s ease; }
        #welcome-screen.hidden { display: none; opacity: 0; }

        .message-wrapper { margin-bottom: 1.25rem; max-width: 100%; }
        .message-wrapper.user { margin-left: auto; max-width: 80%; }
        .user-bubble { background-color: var(--user-bubble-bg); border-bottom-right-radius: 0.3rem; padding: 0.8rem 1.2rem; border-radius: 1.2rem; }
        .final-answer-bubble { background-color: var(--ai-bubble-bg); border: 1px solid #444; padding: 0.8rem 1.2rem; border-radius: 1.2rem; }

        /* Agent Loop Visualization */
        .agent-loop-container { border: 1px solid #444; border-radius: 0.8rem; background-color: var(--ai-bubble-bg); }
        .agent-loop-header { padding: 0.8rem 1.2rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: var(--text-secondary); }
        .agent-loop-body { padding: 0.8rem 1.2rem; border-top: 1px solid #444; }
        .agent-event { margin-bottom: 0.75rem; }
        .agent-event:last-child { margin-bottom: 0; }
        .agent-event-header { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9em; margin-bottom: 0.3rem; color: var(--text-secondary); }
        .agent-event-content { border-radius: 0.5rem; padding: 0.6rem 1rem; font-size: 0.9em; white-space: pre-wrap; word-wrap: break-word; }
        .thought-content { font-style: italic; }
        .tool-call-content { background-color: var(--tool-call-bg); font-family: 'Courier New', Courier, monospace; }
        .tool-output-content { background-color: var(--tool-output-bg); }
        .status-icon.success { color: var(--success-color); }
        .status-icon.failure { color: var(--failure-color); }
        .error-bubble { background-color: #4d2323; color: #ffc4c4; padding: 0.8rem 1.2rem; border-radius: 1.2rem; }

        #chat-input-area { padding: 1rem 1rem; flex-shrink: 0; }
        #message-form .input-group { background-color: var(--surface-color); border-radius: 1.75rem; padding: 0.5rem; align-items: center; }
        #message-input { background: transparent; color: var(--text-primary); border: none; box-shadow: none; font-size: 1.1rem; padding-left: 1rem; }
        #message-input::placeholder { color: var(--text-secondary); }
        #send-button { border-radius: 50% !important; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background-color: var(--primary-accent); border: none; font-size: 1.2rem; }
        #send-button:hover { background-color: var(--primary-accent-hover); }

        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: var(--text-secondary); display: inline-block; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 99; }
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; top: 0; height: 100%; z-index: 100; transform: translateX(-100%); }
            #main-layout.sidebar-open #sidebar { transform: translateX(0); }
            #main-layout.sidebar-open #sidebar-overlay { display: block; }
            #sidebar-toggle { display: block; }
        }
    </style>
</head>
<body>
    <div id="main-layout">
        <div id="sidebar-overlay"></div>
        <aside id="sidebar">
            <button id="new-chat-btn" class="btn btn-primary w-100"><i class="bi bi-plus-lg me-2"></i>New Chat</button>
            <ul id="history-list"></ul>
        </aside>

        <div id="chat-view">
            <header class="chat-header">
                <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
                <h5 class="mb-0">Ethco AI</h5>
                <a href="{{ url_for('logout') }}" class="profile-icon"><i class="bi bi-box-arrow-right"></i></a>
            </header>

            <main id="chat-container"></main>

            <section id="chat-input-area">
                <form id="message-form">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Ask Ethco AI..." autocomplete="off" required>
                        <button class="btn btn-primary" type="submit" id="send-button"><i class="bi bi-arrow-up"></i></button>
                    </div>
                </form>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements & State
        const mainLayout = document.getElementById('main-layout');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatContainer = document.getElementById('chat-container');
        const historyList = document.getElementById('history-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        let currentConversationId = null;

        const toolIcons = {
            list_directory: 'bi-folder',
            create_file: 'bi-file-earmark-plus',
            create_folder: 'bi-folder-plus',
            read_file: 'bi-file-earmark-text',
            write_to_file: 'bi-pencil-square'
        };

        const isMobile = () => window.innerWidth <= 768;
        const toggleSidebar = (forceClose = false) => {
            if (isMobile()) mainLayout.classList.toggle('sidebar-open', !forceClose && !mainLayout.classList.contains('sidebar-open'));
        };
        const scrollToBottom = () => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        const clearChatContainer = () => chatContainer.innerHTML = '';
        
        // --- Agent Event Rendering ---
        const renderAgentEvent = (event, container) => {
            const eventDiv = document.createElement('div');
            eventDiv.classList.add('agent-event');

            const header = document.createElement('div');
            header.classList.add('agent-event-header');
            
            const content = document.createElement('div');
            content.classList.add('agent-event-content');

            let iconClass = '';
            let headerText = '';

            switch(event.type) {
                case 'thought':
                    iconClass = 'bi-lightbulb';
                    headerText = 'Thought';
                    content.classList.add('thought-content');
                    content.innerHTML = marked.parse(event.content);
                    break;
                case 'tool_call':
                    const toolName = event.content.split('(')[0];
                    iconClass = toolIcons[toolName] || 'bi-gear';
                    headerText = 'Using Tool';
                    content.classList.add('tool-call-content');
                    content.textContent = event.content;
                    break;
                case 'tool_output':
                    const isError = event.content.toLowerCase().startsWith('error:');
                    iconClass = isError ? 'bi-x-circle-fill' : 'bi-check-circle-fill';
                    header.classList.add(isError ? 'failure' : 'success');
                    headerText = 'Tool Result';
                    content.classList.add('tool-output-content');
                    content.textContent = event.content;
                    break;
            }

            header.innerHTML = `<i class="bi ${iconClass} status-icon"></i> ${headerText}`;
            eventDiv.appendChild(header);
            eventDiv.appendChild(content);
            container.appendChild(eventDiv);
        };

        const renderResponse = (events) => {
            const finalAnswerEvent = events.find(e => e.type === 'final_answer');
            const loopEvent = events.find(e => e.type === 'loop_event');
            const errorEvent = events.find(e => e.type === 'error');

            if (loopEvent) {
                const loopContainer = document.createElement('div');
                loopContainer.classList.add('message-wrapper', 'ai');
                
                const collapseId = `collapse-${Date.now()}`;
                loopContainer.innerHTML = `
                    <div class="agent-loop-container">
                        <div class="agent-loop-header" data-bs-toggle="collapse" href="#${collapseId}">
                            <i class="bi bi-robot"></i> Agent is thinking... <i class="bi bi-chevron-down ms-auto"></i>
                        </div>
                        <div class="collapse agent-loop-body" id="${collapseId}"></div>
                    </div>
                `;
                
                const loopBody = loopContainer.querySelector('.agent-loop-body');
                loopEvent.content.forEach(subEvent => renderAgentEvent(subEvent, loopBody));
                chatContainer.appendChild(loopContainer);
            }

            if (finalAnswerEvent) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('message-wrapper', 'ai');
                const bubble = document.createElement('div');
                bubble.classList.add('final-answer-bubble');
                bubble.innerHTML = marked.parse(finalAnswerEvent.content);
                wrapper.appendChild(bubble);
                chatContainer.appendChild(wrapper);
            }
            
            if (errorEvent) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('message-wrapper', 'ai');
                const bubble = document.createElement('div');
                bubble.classList.add('error-bubble');
                bubble.textContent = errorEvent.content;
                wrapper.appendChild(bubble);
                chatContainer.appendChild(wrapper);
            }
        };

        const submitPrompt = async (promptText) => {
            if (currentConversationId === null) {
                clearChatContainer();
                chatContainer.innerHTML = ''; // Ensure it's empty
            }
            
            const userWrapper = document.createElement('div');
            userWrapper.classList.add('message-wrapper', 'user');
            userWrapper.innerHTML = `<div class="user-bubble">${promptText}</div>`;
            chatContainer.appendChild(userWrapper);
            scrollToBottom();

            const thinkingBubble = document.createElement('div');
            thinkingBubble.classList.add('message-wrapper', 'ai');
            thinkingBubble.innerHTML = `<div class="final-answer-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatContainer.appendChild(thinkingBubble);
            scrollToBottom();

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText, conversation_id: currentConversationId }),
                });
                
                const data = await response.json();
                thinkingBubble.remove();
                
                if (!response.ok) throw new Error(data.error || 'Unknown API error');

                if (currentConversationId === null) {
                    currentConversationId = data.conversation_id;
                    await loadHistory();
                }
                
                renderResponse(data.events);

            } catch (error) {
                console.error('Fetch Error:', error);
                thinkingBubble.remove();
                renderResponse([{ type: 'error', content: `Error: ${error.message}` }]);
            } finally {
                scrollToBottom();
            }
        };

        const loadConversation = async (id) => {
            if (id === currentConversationId) return;
            currentConversationId = id;
            clearChatContainer();
            
            document.querySelectorAll('.history-item').forEach(item => item.classList.toggle('active', item.dataset.id == id));

            const response = await fetch(`/api/conversation/${id}`);
            const messages = await response.json();
            messages.forEach(msg => {
                const wrapper = document.createElement('div');
                wrapper.classList.add('message-wrapper', msg.sender === 'user' ? 'user' : 'ai');
                const bubbleClass = msg.sender === 'user' ? 'user-bubble' : 'final-answer-bubble';
                wrapper.innerHTML = `<div class="${bubbleClass}">${marked.parse(msg.content)}</div>`;
                chatContainer.appendChild(wrapper);
            });
            scrollToBottom();
            toggleSidebar(true);
        };

        const loadHistory = async () => {
            const response = await fetch('/api/history');
            const conversations = await response.json();
            historyList.innerHTML = '';
            conversations.forEach(conv => {
                const item = document.createElement('li');
                item.classList.add('history-item');
                item.textContent = conv.title;
                item.dataset.id = conv.id;
                if (conv.id === currentConversationId) item.classList.add('active');
                item.addEventListener('click', () => loadConversation(conv.id));
                historyList.appendChild(item);
            });
        };
        
        const startNewChat = () => {
            currentConversationId = null;
            clearChatContainer();
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
            toggleSidebar(true);
        };

        // Event Listeners
        messageForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const userText = messageInput.value.trim();
            if (userText === '') return;
            messageInput.value = '';
            await submitPrompt(userText);
        });
        
        newChatBtn.addEventListener('click', startNewChat);
        sidebarToggle.addEventListener('click', () => toggleSidebar());
        sidebarOverlay.addEventListener('click', () => toggleSidebar(true));

        // Initial Load
        document.addEventListener('DOMContentLoaded', () => loadHistory());
    </script>
</body>
</html>
